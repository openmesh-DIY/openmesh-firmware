#include <SPI.h>
#include <LoRa.h>
#include <Wire.h>
#include <U8g2lib.h>
#include <OneButton.h>
#include "mbedtls/gcm.h"
#include <Preferences.h>
#include "BluetoothSerial.h"

// ================= FIXED CONFIG =================
#define BROADCAST_ID 0xFFFF
#define MAX_TTL 8
#define LORA_SYNCWORD 0x12
#define IV_SIZE 12
#define TAG_SIZE 16
#define MSG_COUNT 4

enum Preset { LONG_SLOW, LONG_FAST, MED_FAST, SHORT_FAST };

struct MeshMsg {
  char text[20];
  uint32_t timestamp;
  bool isTX;
  bool active = false;
};

struct __attribute__((packed)) OpenMeshHeader {
  uint8_t version;
  uint8_t ttl;
  uint16_t src;
  uint16_t dest;
  uint16_t msg_id;
  uint16_t payload_len;
};

// AES-256-GCM Key
unsigned char mesh_key[] = {
  0x1A,0x2B,0x3C,0x4D,0x5E,0x6F,0x70,0x81,
  0x92,0xA3,0xB4,0xC5,0xD6,0xE7,0xF8,0x09,
  0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88,
  0x99,0xAA,0xBB,0xCC,0xDD,0xEE,0xFF,0x00
};

// ================= HARDWARE PINS =================
#define BUTTON_PIN 13
#define OLED_SDA 21
#define OLED_SCL 22
#define LORA_SCK 18
#define LORA_MISO 19
#define LORA_MOSI 23
#define LORA_SS 5
#define LORA_RST 14
#define LORA_DIO0 26

// ================= SPEAKER =================
#define SPEAKER_PIN 27

U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE, OLED_SCL, OLED_SDA);
OneButton button(BUTTON_PIN, true);
BluetoothSerial SerialBT;

// ================= SYSTEM STATE =================
uint16_t nodeID;
String nodeName;

int menuIdx = 0;
Preset currentP = LONG_SLOW;
long freq = 433000000L;

int lastRSSI = -128;
int noiseFloor = -128;
float lastSNR = 0;

uint32_t relayedCount = 0;
uint32_t txPkts = 0;
uint32_t rxPkts = 0;

MeshMsg terminal[MSG_COUNT];

uint16_t neighbors[5];
int neighborCount = 0;

uint32_t seenMsgs[12];
int seenIdx = 0;

// ================= SPEAKER TONES =================
void beep(int f, int d) {
  tone(SPEAKER_PIN, f, d);
  delay(d);
  noTone(SPEAKER_PIN);
  delay(40);
}

void soundMenu() {
  beep(1200, 500);
}

void soundSend() {
  beep(1500,120);
  beep(900,180);
  beep(1500,120);
  beep(900,180);
  beep(1800,250);
}

void soundReceive() {
  for(int i=0;i<3;i++){
    beep(1600,120);
    beep(1600,120);
    beep(2000,600);
    beep(700,1200);
    delay(200);
  }
}

// ================= LOGO BITMAP =================
const unsigned char PROGMEM openmesh_logo_bits[1024] = {
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF4,0x13,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE7,0x71,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x33,0xE6,0x01,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x38,0x86,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x18,0x0C,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x1E,0x0C,0x1C,0x3C,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x84,0x07,0x0C,0x18,0xF0,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x9F,0x01,0x06,0x30,0xC0,0x7C,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0x31,0x00,0x07,0x20,0x00,0xE6,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0x31,0x00,0x1B,0x60,0x00,0xC6,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0x31,0x00,0x18,0x00,0x00,0xC6,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0x3B,0x00,0x18,0x00,0x00,0xEE,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x18,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x18,0x00,0x00,0x18,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x1C,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x06,0x00,0xFE,0x3F,0x00,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0E,0x00,0x06,0x30,0x00,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0E,0x00,0x06,0x30,0x00,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0E,0x00,0x46,0x34,0x00,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0E,0x04,0xE6,0x34,0x10,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0E,0x06,0xB6,0x32,0x30,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0E,0x07,0x96,0x33,0x70,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0E,0x03,0x16,0x31,0x60,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x8E,0x01,0x06,0x30,0xC0,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x8E,0x01,0x06,0x30,0xC0,0x11,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xCE,0x00,0x06,0x30,0x80,0x11,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x6E,0x00,0x06,0x30,0x00,0x13,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x64,0x00,0xFE,0x3F,0x00,0x13,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0x31,0x00,0x80,0x00,0x00,0xC6,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0xB1,0xFF,0xDF,0xFC,0xFF,0xC6,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0x31,0xFF,0xDF,0xFC,0x7F,0xC6,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0x3B,0x00,0xC0,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x9F,0x01,0xC0,0x00,0xC0,0x7D,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x84,0x07,0xC0,0x00,0xF0,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0xC0,0x00,0x3C,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x38,0xC0,0x00,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xC0,0x80,0x07,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x03,0xE0,0x01,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC7,0x71,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE4,0x13,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

// ================= CORE FUNCTIONS =================
void addTerminal(const char* msg, bool tx) {
  for (int i = 0; i < MSG_COUNT - 1; i++) terminal[i] = terminal[i+1];
  strncpy(terminal[MSG_COUNT-1].text, msg, 19);
  terminal[MSG_COUNT-1].timestamp = millis();
  terminal[MSG_COUNT-1].isTX = tx;
  terminal[MSG_COUNT-1].active = true;
}

void applyLoRa() {
  LoRa.end();
  SPI.begin(LORA_SCK, LORA_MISO, LORA_MOSI, LORA_SS);
  LoRa.setPins(LORA_SS, LORA_RST, LORA_DIO0);
  if (!LoRa.begin(freq)) return;

  if(currentP == LONG_SLOW) {
    LoRa.setSpreadingFactor(12);
    LoRa.setSignalBandwidth(62500);
  } else if(currentP == LONG_FAST) {
    LoRa.setSpreadingFactor(11);
    LoRa.setSignalBandwidth(250000);
  } else if(currentP == MED_FAST) {
    LoRa.setSpreadingFactor(9);
    LoRa.setSignalBandwidth(250000);
  } else {
    LoRa.setSpreadingFactor(7);
    LoRa.setSignalBandwidth(250000);
  }

  LoRa.setCodingRate4(5);
  LoRa.setSyncWord(LORA_SYNCWORD);
  LoRa.enableCrc();
  LoRa.receive();
}

void secure_send(const char* msg, uint16_t dest) {
  soundSend();

  int len = strlen(msg);
  uint8_t iv[IV_SIZE], tag[TAG_SIZE];
  uint8_t ciphertext[100];

  for(int i=0;i<IV_SIZE;i++) iv[i]=esp_random();

  mbedtls_gcm_context gcm;
  mbedtls_gcm_init(&gcm);
  mbedtls_gcm_setkey(&gcm, MBEDTLS_CIPHER_ID_AES, mesh_key, 256);
  mbedtls_gcm_crypt_and_tag(&gcm, MBEDTLS_GCM_ENCRYPT,
    len, iv, IV_SIZE, NULL, 0,
    (const uint8_t*)msg, ciphertext, TAG_SIZE, tag);
  mbedtls_gcm_free(&gcm);

  OpenMeshHeader h = {2, MAX_TTL, nodeID, dest, (uint16_t)random(0,65535), (uint16_t)len};

  LoRa.beginPacket();
  LoRa.write((uint8_t*)&h, sizeof(h));
  LoRa.write(iv, IV_SIZE);
  LoRa.write(tag, TAG_SIZE);
  LoRa.write(ciphertext, len);
  LoRa.endPacket(true);
  LoRa.receive();

  txPkts++;
  addTerminal(msg, true);
}

// ================= SETUP =================
void setup() {
  pinMode(SPEAKER_PIN, OUTPUT);

  u8g2.begin();
  Serial.begin(115200);

  nodeID = (uint16_t)ESP.getEfuseMac();
  nodeName = "CORE-" + String(nodeID, HEX);
  nodeName.toUpperCase();

  SerialBT.begin(nodeName);

  uint32_t startTest = millis();
  while (millis() - startTest < 3000) {
    u8g2.clearBuffer();
    u8g2.drawXBMP(0,0,128,64,openmesh_logo_bits);
    u8g2.setFont(u8g2_font_4x6_tf);

    LoRa.setPins(5,14,26);
    if(!LoRa.begin(freq)) {
      u8g2.setCursor(0,63);
      u8g2.print("LORA FAILED!");
      u8g2.sendBuffer();
      while(1);
    }

    u8g2.setCursor(0,63);
    u8g2.print("Hardware Test: OK");
    u8g2.sendBuffer();
    delay(100);
  }

  button.attachClick([](){
    soundMenu();
    if(menuIdx==3){
      currentP=(Preset)((currentP+1)%4);
      applyLoRa();
    } else {
      menuIdx=(menuIdx+1)%7;
    }
  });

  button.attachDoubleClick([](){
    soundMenu();
    menuIdx=(menuIdx+1)%7;
  });

  button.attachLongPressStart([](){
    soundMenu();
    freq+=1000000L;
    if(freq>450000000L) freq=410000000L;
    applyLoRa();
  });

  applyLoRa();
  addTerminal("MESH ONLINE", true);
}

// ================= LOOP =================
void loop() {
  button.tick();

  int sz = LoRa.parsePacket();
  if (sz >= sizeof(OpenMeshHeader) + IV_SIZE + TAG_SIZE) {
    lastRSSI = LoRa.packetRssi();
    lastSNR = LoRa.packetSnr();
    rxPkts++;

    OpenMeshHeader h;
    LoRa.readBytes((uint8_t*)&h, sizeof(h));

    uint8_t iv[IV_SIZE], tag[TAG_SIZE];
    uint8_t ciphertext[100], plaintext[100];

    LoRa.readBytes(iv, IV_SIZE);
    LoRa.readBytes(tag, TAG_SIZE);
    LoRa.readBytes(ciphertext, h.payload_len);

    mbedtls_gcm_context gcm;
    mbedtls_gcm_init(&gcm);
    mbedtls_gcm_setkey(&gcm, MBEDTLS_CIPHER_ID_AES, mesh_key, 256);

    if(mbedtls_gcm_auth_decrypt(&gcm, h.payload_len,
      iv, IV_SIZE, NULL, 0, tag, TAG_SIZE,
      ciphertext, plaintext)==0) {

      soundReceive();
      plaintext[h.payload_len]=0;
      addTerminal((char*)plaintext,false);
      SerialBT.printf("IN [%04X]: %s\n",h.src,(char*)plaintext);
    }

    mbedtls_gcm_free(&gcm);
  }
}